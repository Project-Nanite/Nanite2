# Shellprocess configuration for final cleanup
# This runs after the main installation to clean up live packages safely

dontChroot: false
timeout: 300

script:
    # Post-installation cleanup script
    - command: "/bin/bash"
      args:
        - "-c"
        - |
          echo "Starting post-installation cleanup..."
          
          # Function to safely remove a package
          safe_remove_package() {
              local package=$1
              if dpkg -l | grep -q "^ii.*$package "; then
                  echo "Attempting to remove $package..."
                  DEBIAN_FRONTEND=noninteractive apt-get remove --purge -y "$package" 2>/dev/null || {
                      echo "Warning: Could not remove $package (likely has dependencies)"
                      return 0
                  }
                  echo "Successfully removed $package"
              else
                  echo "$package not found or already removed"
              fi
          }
          
          # Live packages to remove after installation
          packages_to_remove=(
              "live-boot-doc"
              "live-config-doc"  
              "live-tools"
              "live-task-localisation"
              "live-task-recommended"
              "calamares-settings-debian"
              "calamares"
          )
          
          # Remove packages one by one
          for package in "${packages_to_remove[@]}"; do
              safe_remove_package "$package"
          done
          
          # Clean package cache
          echo "Cleaning package cache..."
          apt-get autoremove -y 2>/dev/null || true
          apt-get autoclean 2>/dev/null || true
          
          # Update initramfs for the installed system
          echo "Updating initramfs..."
          update-initramfs -u -k all || true
          
          echo "Post-installation cleanup completed successfully"
          
      timeout: 180
